<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#151522">
    <title>Masa QR</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B35',
                        secondary: '#1a1a25',
                        'glass-bg': 'rgba(26,26,37,0.8)',
                        'glass-border': 'rgba(255,255,255,0.08)',
                    },
                    backdropBlur: {
                        glass: '10px',
                    },
                }
            }
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-secondary text-white min-h-screen flex flex-col">
    <!-- Yükleme Ekranı -->
    <div id="loadingPage" class="fixed inset-0 bg-secondary flex items-center justify-center z-50">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-primary mb-4"></div>
            <p class="text-white">Yükleniyor...</p>
        </div>
    </div>
    
    <!-- Ana Sayfa -->
    <div id="qrPage" class="container mx-auto px-4 py-8 flex-1 flex flex-col" style="display: none;">
        <header class="mb-8 text-center">
            <h1 id="restaurantName" class="text-2xl font-bold mb-1">Restaurant</h1>
            <p class="text-gray-400">Masa <span id="tableNumber" class="font-bold">0</span></p>
        </header>
        
        <main class="flex-1 flex flex-col items-center justify-center">
            <div class="w-full max-w-md bg-glass-bg border border-glass-border backdrop-blur-glass rounded-xl p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">Garson Çağırma</h2>
                <p class="text-gray-300 mb-6">Garsona ihtiyacınız olduğunda aşağıdaki butona tıklayarak çağırabilirsiniz.</p>
                
                <button id="callWaiterBtn" class="w-full bg-primary hover:bg-primary/80 text-white font-medium py-3 px-4 rounded-lg transition-all flex items-center justify-center">
                    <i class="ri-user-voice-line mr-2"></i> <span id="callButtonText">Garsonu Çağır</span>
                </button>
                
                <div id="activeLabel" class="text-center mt-4 text-sm text-green-400 hidden">
                    <i class="ri-time-line mr-1"></i> Garson çağrınız alındı
                </div>
            </div>
            
            <!-- Bildirimler -->
            <div id="errorAlert" class="w-full max-w-md bg-red-500/20 border border-red-500/30 text-red-100 p-4 rounded-lg mb-4" style="display: none;"></div>
            <div id="successAlert" class="w-full max-w-md bg-green-500/20 border border-green-500/30 text-green-100 p-4 rounded-lg mb-4" style="display: none;"></div>
            <div id="waiterResponseAlert" class="w-full max-w-md bg-blue-500/20 border border-blue-500/30 text-blue-100 p-4 rounded-lg mb-4" style="display: none;"></div>
        </main>
        
        <footer class="mt-auto pt-8 text-center text-gray-400 text-sm">
            <p>QR Garson Çağırma Sistemi</p>
        </footer>
    </div>
    
    <script>
        // Supabase bağlantısı - 1sthillman/qr projesine uyumlu
        const SUPABASE_URL = 'https://wihdzkvgttfwsiijxidy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndpaGR6a3ZndHRmd3NpaWp4aWR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MzA0MjIsImV4cCI6MjA2NjIwNjQyMn0.Cpn6y7ybyLA3uL-bjvsxPKoIw-J7I6eTE5cPGnBjOo4';
        
        // Global değişkenler
        let supabase;
        let restaurantId = '';
        let tableNumber = '';
        let tableId = null;
        let currentCallId = null;
        let isCallActive = false;
        let currentStatus = 'idle';
        
        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sayfa yüklendi');
            
            // URL parametrelerini al
            const urlParams = new URLSearchParams(window.location.search);
            restaurantId = urlParams.get('restaurant_id');
            
            // table_id veya table parametresi kontrolü
            tableNumber = urlParams.get('table_id') || urlParams.get('table');
            
            // Değerler yoksa hata göster
            if (!restaurantId || !tableNumber) {
                showError('QR kodda eksik bilgi var. Lütfen geçerli bir QR kod kullanın.');
                console.error('Eksik parametreler:', { restaurantId, tableNumber });
                return;
            }
            
            console.log('Parametreler alındı:', { restaurantId, tableNumber });
            
            // Supabase'i başlat
            initSupabase();
            
            // Sayfa içeriğini göster
            document.getElementById('loadingPage').style.display = 'none';
            document.getElementById('qrPage').style.display = 'flex';
            
            // Masa ve restoran bilgilerini göster
            document.getElementById('tableNumber').textContent = tableNumber;
            document.getElementById('restaurantName').textContent = `Restaurant ${restaurantId}`;
            
            // Masa kaydını kontrol et veya oluştur
            checkOrCreateTable();
            
            // Çağrı butonunu ayarla
            setupCallButton();
            
            // Realtime bağlantıyı kur
            setupRealtimeConnection();
        });
        
        // Supabase istemcisini başlat
        function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase bağlantısı başarılı');
                return true;
            } catch (error) {
                console.error('Supabase başlatma hatası:', error);
                showError('Veritabanı bağlantısı kurulamadı. Lütfen tekrar deneyin.');
                return false;
            }
        }
        
        // Masa kaydını kontrol et veya oluştur
        async function checkOrCreateTable() {
            if (!supabase) return;
            
            try {
                console.log(`Masa kontrolü yapılıyor: Restaurant ${restaurantId}, Masa ${tableNumber}`);
                
                // Önce masa var mı kontrol et
                const { data, error } = await supabase
                    .from('tables')
                    .select('id, status')
                    .eq('restaurant_id', restaurantId)
                    .eq('table_id', parseInt(tableNumber))
                    .single();
                
                if (error && error.code !== 'PGRST116') { // PGRST116: No rows returned
                    console.error('Masa sorgusu hatası:', error);
                    return;
                }
                
                if (data) {
                    // Masa bulundu
                    tableId = data.id;
                    currentStatus = data.status || 'idle';
                    console.log(`Masa bulundu: ID=${tableId}, Status=${currentStatus}`);
                } else {
                    // Masa yoksa oluştur
                    const { data: newTable, error: insertError } = await supabase
                        .from('tables')
                        .insert({
                            restaurant_id: restaurantId,
                            table_id: parseInt(tableNumber),
                            number: parseInt(tableNumber),
                            status: 'idle'
                        })
                        .select()
                        .single();
                    
                    if (insertError) {
                        console.error('Masa oluşturma hatası:', insertError);
                        return;
                    }
                    
                    tableId = newTable.id;
                    currentStatus = 'idle';
                    console.log(`Yeni masa oluşturuldu: ID=${tableId}`);
                }
                
                // Aktif çağrı var mı kontrol et
                checkActiveCall();
                
            } catch (err) {
                console.error('Masa kontrolü hatası:', err);
            }
        }
        
        // Aktif çağrı var mı kontrol et
        async function checkActiveCall() {
            if (!supabase || !tableId) return;
            
            try {
                const { data, error } = await supabase
                    .from('calls')
                    .select('id, status')
                    .eq('table_id', tableId)
                    .eq('status', 'requested')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Çağrı sorgusu hatası:', error);
                    return;
                }
                
                if (data) {
                    // Aktif çağrı var
                    currentCallId = data.id;
                    isCallActive = true;
                    currentStatus = 'calling';
                    console.log(`Aktif çağrı bulundu: ID=${currentCallId}`);
                    
                    // Buton durumunu güncelle
                    updateButtonState();
                }
            } catch (err) {
                console.error('Aktif çağrı kontrolü hatası:', err);
            }
        }
        
        // Garson çağırma işlevi
        function setupCallButton() {
            const callWaiterBtn = document.getElementById('callWaiterBtn');
            const callButtonText = document.getElementById('callButtonText');
            const activeLabel = document.getElementById('activeLabel');
            
            if (!callWaiterBtn) return;
            
            // Başlangıçta buton durumunu ayarla
            updateButtonState();
            
            callWaiterBtn.addEventListener('click', async function() {
                // Eğer servis durumundaysa, butonu devre dışı bırak
                if (currentStatus === 'serving') {
                    showToast('success', 'Garson Geliyor', 'Garson masanıza yönlendirildi');
                    return;
                }
                
                const newStatus = isCallActive ? 'idle' : 'calling';
                
                // Supabase'e durum güncelleme
                try {
                    // Butonu devre dışı bırak
                    callWaiterBtn.disabled = true;
                    
                    if (newStatus === 'calling') {
                        // Çağrı yapılıyor
                        callButtonText.innerHTML = '<i class="ri-loader-2-line animate-spin mr-2"></i> Garson çağrılıyor...';
                        
                        // 1. Masa durumunu 'calling' olarak güncelle
                        const { error: tableError } = await supabase
                            .from('tables')
                            .upsert({
                                restaurant_id: restaurantId,
                                table_id: parseInt(tableNumber),
                                number: parseInt(tableNumber),
                                status: 'calling',
                                updated_at: new Date().toISOString()
                            });
                            
                        if (tableError) {
                            console.error('Masa durumu güncellenemedi:', tableError);
                            showError('Masa durumu güncellenemedi. Lütfen tekrar deneyin.');
                            callWaiterBtn.disabled = false;
                            callButtonText.textContent = 'Garsonu Çağır';
                            return;
                        }
                        
                        console.log(`Masa ${tableNumber} durumu 'calling' olarak güncellendi`);
                        
                        // 2. Çağrı oluştur
                        const { data: callData, error: callError } = await supabase
                            .from('calls')
                            .insert({
                                table_id: tableId,
                                status: 'requested'
                            })
                            .select()
                            .single();
                            
                        if (callError) {
                            console.error('Garson çağrısı oluşturulamadı:', callError);
                            showError('Garson çağrısı yapılamadı. Lütfen tekrar deneyin.');
                            callWaiterBtn.disabled = false;
                            callButtonText.textContent = 'Garsonu Çağır';
                            return;
                        }
                        
                        // Çağrı ID'sini kaydet
                        currentCallId = callData.id;
                        isCallActive = true;
                        currentStatus = 'calling';
                        
                        // Başarı mesajı göster
                        showSuccess('Garson çağrınız alındı. En kısa sürede sizinle ilgileneceğiz.');
                        
                    } else {
                        // Çağrı iptal ediliyor
                        callButtonText.innerHTML = '<i class="ri-loader-2-line animate-spin mr-2"></i> İptal ediliyor...';
                        
                        // 1. Masa durumunu 'idle' olarak güncelle
                        const { error: tableError } = await supabase
                            .from('tables')
                            .update({ status: 'idle' })
                            .eq('id', tableId);
                            
                        if (tableError) {
                            console.error('Masa durumu güncellenemedi:', tableError);
                            showError('Çağrı iptal edilemedi. Lütfen tekrar deneyin.');
                            callWaiterBtn.disabled = false;
                            return;
                        }
                        
                        // 2. Çağrıyı iptal et
                        if (currentCallId) {
                            const { error: callError } = await supabase
                                .from('calls')
                                .update({ status: 'cancelled' })
                                .eq('id', currentCallId);
                                
                            if (callError) {
                                console.error('Çağrı iptal edilemedi:', callError);
                            }
                        }
                        
                        isCallActive = false;
                        currentStatus = 'idle';
                        currentCallId = null;
                        
                        // Başarı mesajı göster
                        showSuccess('Garson çağrısı iptal edildi.');
                    }
                    
                    // Buton durumunu güncelle
                    updateButtonState();
                    
                } catch (error) {
                    console.error('Garson çağırma hatası:', error);
                    showError('Bir hata oluştu. Lütfen tekrar deneyin.');
                    callWaiterBtn.disabled = false;
                }
            });
        }
        
        // Buton durumunu güncelle
        function updateButtonState() {
            const callWaiterBtn = document.getElementById('callWaiterBtn');
            const callButtonText = document.getElementById('callButtonText');
            const activeLabel = document.getElementById('activeLabel');
            
            if (!callWaiterBtn || !callButtonText || !activeLabel) return;
            
            callWaiterBtn.disabled = false;
            
            if (currentStatus === 'calling') {
                callWaiterBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                callWaiterBtn.classList.remove('bg-primary', 'hover:bg-primary/80');
                callButtonText.innerHTML = '<i class="ri-close-line mr-2"></i> İptal Et';
                activeLabel.classList.remove('hidden');
            } else if (currentStatus === 'serving') {
                callWaiterBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                callWaiterBtn.classList.remove('bg-primary', 'hover:bg-primary/80', 'bg-red-500', 'hover:bg-red-600');
                callButtonText.innerHTML = '<i class="ri-user-smile-line mr-2"></i> Garson Geliyor';
                callWaiterBtn.disabled = true;
                activeLabel.classList.add('hidden');
            } else {
                callWaiterBtn.classList.add('bg-primary', 'hover:bg-primary/80');
                callWaiterBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-green-500', 'hover:bg-green-600');
                callButtonText.innerHTML = '<i class="ri-user-voice-line mr-2"></i> Garsonu Çağır';
                activeLabel.classList.add('hidden');
            }
        }
        
        // Realtime bağlantıyı kur
        function setupRealtimeConnection() {
            if (!supabase || !tableId) return;
            
            console.log('Realtime bağlantı kuruluyor...');
            
            // Masa durumu değişikliklerini dinle
            supabase
                .channel('table-status-changes')
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'tables',
                    filter: `id=eq.${tableId}`
                }, payload => {
                    console.log('Masa durumu değişti:', payload);
                    
                    if (payload.new.status) {
                        currentStatus = payload.new.status;
                        updateButtonState();
                        
                        if (currentStatus === 'serving') {
                            showWaiterResponse('Garsonunuz geliyor!');
                        }
                    }
                })
                .subscribe(status => {
                    console.log('Masa durumu dinleme durumu:', status);
                });
            
            // Çağrı durumu değişikliklerini dinle
            if (currentCallId) {
                supabase
                    .channel('call-status-changes')
                    .on('postgres_changes', { 
                        event: 'UPDATE', 
                        schema: 'public', 
                        table: 'calls',
                        filter: `id=eq.${currentCallId}`
                    }, payload => {
                        console.log('Çağrı durumu değişti:', payload);
                        
                        if (payload.new.status === 'acknowledged') {
                            showWaiterResponse('Garsonunuz geliyor!');
                            isCallActive = false;
                            currentStatus = 'serving';
                            updateButtonState();
                        }
                    })
                    .subscribe(status => {
                        console.log('Çağrı durumu dinleme durumu:', status);
                    });
            }
        }
        
        // Hata mesajı göster
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            if (!errorAlert) return;
            
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }
        
        // Başarı mesajı göster
        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            if (!successAlert) return;
            
            successAlert.textContent = message;
            successAlert.style.display = 'block';
            
            setTimeout(() => {
                successAlert.style.display = 'none';
            }, 5000);
        }
        
        // Garson yanıt mesajı göster
        function showWaiterResponse(message) {
            const waiterResponseAlert = document.getElementById('waiterResponseAlert');
            if (!waiterResponseAlert) return;
            
            waiterResponseAlert.textContent = message;
            waiterResponseAlert.style.display = 'block';
            
            setTimeout(() => {
                waiterResponseAlert.style.display = 'none';
            }, 10000);
        }
        
        // Toast mesajı göster
        function showToast(type, title, message) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 bg-${type === 'success' ? 'green' : 'red'}-500 text-white p-4 rounded-lg shadow-lg`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="ri-${type === 'success' ? 'check' : 'error'}-warning-line text-2xl mr-2"></i>
                    <div>
                        <h4 class="font-bold">${title}</h4>
                        <p>${message}</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
    </script>
</body>
</html> 